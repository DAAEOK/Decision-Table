<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê²°ì •ì‹íƒ (Decision Table) | Prototype</title>
    <meta
      name="description"
      content="ìƒíƒœ 10ì´ˆ ì…ë ¥ â†’ ì„œë¡œ ë‹¤ë¥¸ ì´ìœ  3ê°œ í›„ë³´ â†’ 1ê°œ ê²°ì •. ëŒ€ì²´ ë©”ë‰´ëŠ” 1ê°œì”© êµì²´. ê²°ì •ì€ ì—¬ê¸°ì„œ ë."
    />
    <style>
      :root {
        --bg: #0b0c10;
        --surface: rgba(255, 255, 255, 0.06);
        --surface2: rgba(255, 255, 255, 0.09);
        --border: rgba(255, 255, 255, 0.12);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.72);
        --muted2: rgba(255, 255, 255, 0.55);
        --accent: #7c5cff;
        --accent2: #00d1ff;
        --good: #28d17c;
        --warn: #ffb020;
        --bad: #ff5c7a;
        --shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
        --radius: 18px;
        --radius2: 14px;
        --gap: 14px;
        --max: 1120px;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", Arial,
          sans-serif;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--text);
        background: radial-gradient(
            1200px 600px at 20% 0%,
            rgba(124, 92, 255, 0.22),
            transparent 55%
          ),
          radial-gradient(
            900px 500px at 80% 10%,
            rgba(0, 209, 255, 0.18),
            transparent 55%
          ),
          linear-gradient(180deg, #07080b, #0b0c10 40%, #07080b);
      }

      a {
        color: inherit;
      }
      .back-link {
        display: inline-block;
        margin: 16px 0;
        font-size: 14px;
        color: #fff;
        text-decoration: none;
      }
      .back-link:hover {
        text-decoration: underline;
      }

      .wrap {
        max-width: var(--max);
        margin: 0 auto;
        padding: 22px 18px 60px;
      }

      .topbar {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        border-radius: 16px;
        backdrop-filter: blur(10px);
      }
      .brand {
        display: flex;
        gap: 10px;
        align-items: center;
        min-width: 0;
      }
      .logo {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        box-shadow: 0 10px 30px rgba(124, 92, 255, 0.25);
      }
      .brand h1 {
        font-size: 14px;
        line-height: 1.1;
        margin: 0;
      }
      .brand p {
        margin: 0;
        font-size: 12px;
        color: var(--muted2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .btn {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        border-radius: 14px;
        padding: 10px 12px;
        font-size: 13px;
        cursor: pointer;
        transition: transform 0.06s ease, background 0.18s ease,
          border-color 0.18s ease;
        user-select: none;
      }
      .btn:hover {
        background: rgba(255, 255, 255, 0.09);
        border-color: rgba(255, 255, 255, 0.18);
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn.primary {
        border-color: rgba(124, 92, 255, 0.5);
        background: linear-gradient(
          135deg,
          rgba(124, 92, 255, 0.95),
          rgba(0, 209, 255, 0.85)
        );
        color: #0b0c10;
        font-weight: 700;
      }
      .btn.ghost {
        background: transparent;
      }

      .grid {
        margin-top: 18px;
        display: grid;
        grid-template-columns: 1.05fr 0.95fr;
        gap: 16px;
      }

      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card .hd {
        padding: 16px 16px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .card .hd .title {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
      }
      .card .hd h2 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.2px;
      }
      .card .hd p {
        margin: 0;
        font-size: 12px;
        color: var(--muted2);
      }
      .card .bd {
        padding: 16px;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
      }
      .tag .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--accent2);
      }

      .hero {
        display: grid;
        gap: 10px;
      }
      .hero h3 {
        margin: 0;
        font-size: 22px;
        letter-spacing: -0.2px;
        line-height: 1.25;
      }
      .hero p {
        margin: 0;
        color: var(--muted);
        line-height: 1.55;
        font-size: 14px;
      }
      .hero .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }

      .steps {
        display: none;
      }
      .steps.active {
        display: block;
      }

      .progress {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .pill {
        height: 8px;
        width: 48px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        overflow: hidden;
      }
      .pill > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), var(--accent2));
      }

      .q {
        margin: 0 0 10px;
        font-size: 14px;
      }

      .options {
        display: grid;
        gap: 10px;
      }
      .opt {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 12px 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.04);
        cursor: pointer;
        transition: background 0.18s ease, border-color 0.18s ease,
          transform 0.06s ease;
      }
      .opt:hover {
        background: rgba(255, 255, 255, 0.07);
        border-color: rgba(255, 255, 255, 0.18);
      }
      .opt:active {
        transform: translateY(1px);
      }
      .radio {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.35);
        margin-top: 1px;
        display: grid;
        place-items: center;
        flex: 0 0 auto;
      }
      .radio i {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: transparent;
      }
      .opt.selected .radio {
        border-color: rgba(0, 209, 255, 0.8);
      }
      .opt.selected .radio i {
        background: linear-gradient(135deg, var(--accent), var(--accent2));
      }
      .opt .lbl {
        display: grid;
        gap: 2px;
      }
      .opt .lbl strong {
        font-size: 13px;
        font-weight: 750;
      }
      .opt .lbl span {
        font-size: 12px;
        color: var(--muted2);
        line-height: 1.35;
      }

      .helper {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted2);
      }

      .nav {
        margin-top: 14px;
        display: flex;
        gap: 8px;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .candidates {
        display: grid;
        gap: 12px;
      }

      .menuCard {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
        border-radius: var(--radius);
        padding: 14px;
        display: grid;
        gap: 10px;
      }
      .menuTop {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
      }
      .menuTitle {
        display: grid;
        gap: 4px;
      }
      .menuTitle .type {
        font-size: 12px;
        color: var(--muted2);
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .badge {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
      }
      .badge.stability {
        border-color: rgba(0, 209, 255, 0.25);
      }
      .badge.satisfy {
        border-color: rgba(124, 92, 255, 0.3);
      }
      .badge.certain {
        border-color: rgba(255, 176, 32, 0.35);
      }
      .badge.speed {
        border-color: rgba(40, 209, 124, 0.35);
      }
      .badge.occasion {
        border-color: rgba(255, 92, 122, 0.35);
      }
      .menuTitle h4 {
        margin: 0;
        font-size: 16px;
        letter-spacing: -0.2px;
      }
      .reason {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
        line-height: 1.45;
      }

      .menuActions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .finalBox {
        padding: 16px;
        border-radius: var(--radius);
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
        display: grid;
        gap: 10px;
      }
      .finalBox .big {
        font-size: 22px;
        font-weight: 800;
        letter-spacing: -0.2px;
      }
      .finalBox .sub {
        color: var(--muted);
        font-size: 13px;
        line-height: 1.45;
      }

      .sideCol {
        display: grid;
        gap: 16px;
      }

      .kv {
        display: grid;
        gap: 10px;
      }
      .kvRow {
        display: grid;
        grid-template-columns: 110px 1fr;
        gap: 10px;
        padding: 10px 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.04);
      }
      .kvRow b {
        font-size: 12px;
        color: var(--muted2);
        font-weight: 700;
      }
      .kvRow span {
        font-size: 12px;
        color: var(--text);
      }

      .codebox {
        border-radius: var(--radius);
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.25);
        padding: 12px;
        font-family: var(--mono);
        color: rgba(255, 255, 255, 0.78);
        font-size: 11px;
        line-height: 1.5;
        overflow: auto;
      }

      .muted {
        color: var(--muted2);
      }

      .sep {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 14px 0;
      }

      .toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 18px;
        background: rgba(0, 0, 0, 0.78);
        color: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.14);
        padding: 10px 12px;
        border-radius: 999px;
        font-size: 13px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .toast.show {
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <a href="../" class="back-link">â† ì„œë¹„ìŠ¤ ì„¤ëª… í˜ì´ì§€ë¡œ</a>
      <div class="topbar">
        <div class="brand">
          <div class="logo"></div>
          <div style="min-width: 0">
            <h1>ê²°ì •ì‹íƒ Prototype</h1>
            <p>ìƒíƒœ 10ì´ˆ ì…ë ¥ â†’ 3ê°œ í›„ë³´ â†’ 1ê°œ ê²°ì •(ì¢…ë£Œ)</p>
          </div>
        </div>
        <div class="actions">
          <button class="btn ghost" id="btnOpenMyData">ë§ˆì´ë°ì´í„°</button>
          <button class="btn" id="btnReset">ë¦¬ì…‹</button>
          <button class="btn primary" id="btnStart">ê²°ì • ì‹œì‘</button>
        </div>
      </div>

      <div class="grid">
        <!-- Main -->
        <section class="card">
          <div class="hd">
            <div class="title">
              <h2 id="stepTitle">01 / ì‹œì‘</h2>
              <p id="stepDesc">
                ì˜¤ëŠ˜ ìƒíƒœë§Œ ì…ë ¥í•˜ë©´, ì´ìœ ê°€ ë‹¤ë¥¸ 3ê°œë§Œ ë³´ì—¬ì¤˜ìš”.
              </p>
            </div>
            <div class="progress" title="ì§„í–‰ë¥ ">
              <div class="pill"><i id="progressBar"></i></div>
            </div>
          </div>

          <div class="bd">
            <!-- HERO -->
            <div class="steps active" data-step="hero">
              <div class="hero">
                <h3>
                  â€œì˜¤ëŠ˜ ë­ ë¨¹ì§€?â€ë¥¼<br />
                  <span style="color: rgba(0, 209, 255, 0.95)">ì¶”ì²œ</span>ì´
                  ì•„ë‹ˆë¼
                  <span style="color: rgba(124, 92, 255, 0.95)">ê²°ì •</span>ìœ¼ë¡œ
                  ë°”ê¾¸ê¸°
                </h3>
                <p>
                  ê²°ì •ì‹íƒì€ ì •í™•ë„ë³´ë‹¤ <b>ê²°ì • ì™„ë£Œ ê²½í—˜</b>ì„ ìš°ì„ í•´ìš”.<br />
                  ê·¸ë˜ì„œ í•œ ë²ˆì— ë§ì´ ë³´ì—¬ì£¼ì§€ ì•Šê³ , <b>ì„œë¡œ ë‹¤ë¥¸ ì´ìœ  3ê°œ</b>ë§Œ
                  ì œì‹œí•˜ê³  ëë‚´ìš”.
                </p>
                <div class="row">
                  <span class="tag"
                    ><span class="dot"></span>ì…ë ¥ ìµœì†Œ(10ì´ˆ)</span
                  >
                  <span class="tag"
                    ><span class="dot"></span>í›„ë³´ 3ê°œ ê³ ì •</span
                  >
                  <span class="tag"
                    ><span class="dot"></span>ëŒ€ì²´ëŠ” 1ê°œì”© êµì²´</span
                  >
                  <span class="tag"
                    ><span class="dot"></span>ê²°ì •ì€ ì—¬ê¸°ì„œ ì¢…ë£Œ</span
                  >
                </div>

                <div class="sep"></div>

                <div class="nav">
                  <button class="btn" id="btnHeroMyData">
                    ë§ˆì´ë°ì´í„° ë¨¼ì € ì„¤ì •
                  </button>
                  <button class="btn primary" id="btnHeroGoInput">
                    ë°”ë¡œ ì…ë ¥ ì‹œì‘
                  </button>
                </div>
              </div>
            </div>

            <!-- INPUT 1: Hunger -->
            <div class="steps" data-step="hunger">
              <p class="q"><b>ì§€ê¸ˆ ì–¼ë§ˆë‚˜ ë°°ê³ í”ˆê°€ìš”?</b></p>
              <div class="options" id="optsHunger">
                <div class="opt" data-value="1">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ì¡°ê¸ˆ</strong>
                    <span>ê°€ë³ê²Œ ë¨¹ì–´ë„ ë§Œì¡±í•  ìˆ˜ ìˆì–´ìš”</span>
                  </div>
                </div>
                <div class="opt" data-value="2">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ë³´í†µ</strong>
                    <span>ë¬´ë‚œí•œ í•œ ë¼ê°€ í•„ìš”í•´ìš”</span>
                  </div>
                </div>
                <div class="opt" data-value="3">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ë§ì´</strong>
                    <span>í¬ë§Œê°ì´ í™•ì‹¤í•´ì•¼ í•´ìš”</span>
                  </div>
                </div>
              </div>
              <div class="helper">
                ë°°ê³ í””ì€ í¬ë§Œê°(í™•ì‹¤í˜•/ì•ˆì •í˜•)ì˜ ìš°ì„ ìˆœìœ„ì— ì˜í–¥ì„ ì¤˜ìš”.
              </div>
              <div class="nav">
                <button class="btn" data-nav="back">ì´ì „</button>
                <button class="btn primary" data-nav="next">ë‹¤ìŒ</button>
              </div>
            </div>

            <!-- INPUT 2: Stress -->
            <div class="steps" data-step="stress">
              <p class="q"><b>ì˜¤ëŠ˜ ì»¨ë””ì…˜ì€ ì–´ë•Œìš”?</b></p>
              <div class="options" id="optsStress">
                <div class="opt" data-value="1">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ì—¬ìœ  ìˆì–´ìš”</strong>
                    <span>ê°€ë³ê²Œ ì¦ê¸¸ ìˆ˜ ìˆì–´ìš”</span>
                  </div>
                </div>
                <div class="opt" data-value="2">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ë³´í†µì´ì—ìš”</strong>
                    <span>ë¬´ë‚œí•œ ë§Œì¡±ê°ì´ ì¢‹ì•„ìš”</span>
                  </div>
                </div>
                <div class="opt" data-value="3">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ë§ì´ ì§€ì³ìš”</strong>
                    <span>ìê·¹ì€ ì¤„ì´ê³  ì‹¤íŒ¨ ì—†ëŠ” ì„ íƒì´ ì¢‹ì•„ìš”</span>
                  </div>
                </div>
              </div>
              <div class="helper">
                ìŠ¤íŠ¸ë ˆìŠ¤ëŠ” ì•ˆì •í˜•/ë§Œì¡±í˜•ì˜ ë¹„ì¤‘ê³¼ ìê·¹ í—ˆìš©ë„ë¥¼ ë°”ê¿”ìš”.
              </div>
              <div class="nav">
                <button class="btn" data-nav="back">ì´ì „</button>
                <button class="btn primary" data-nav="next">ë‹¤ìŒ</button>
              </div>
            </div>

            <!-- INPUT 3: Time -->
            <div class="steps" data-step="time">
              <p class="q"><b>ì§€ê¸ˆì€ ì–¸ì œì¸ê°€ìš”?</b></p>
              <div class="options" id="optsTime">
                <div class="opt" data-value="lunch">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ì ì‹¬</strong>
                    <span>í™œë™ì„ ìœ„í•œ ë¬´ë‚œí•œ í¬ë§Œê°</span>
                  </div>
                </div>
                <div class="opt" data-value="dinner">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ì €ë…</strong>
                    <span>í›„íšŒê°€ ì ê³  ë¶€ë‹´ì„ ì¡°ì ˆí•˜ëŠ” ì„ íƒ</span>
                  </div>
                </div>
              </div>
              <div class="helper">
                ì‹œê°„ëŒ€ëŠ” â€œë¬´ê±°ì›€ í—ˆìš©â€ê³¼ â€œí›„íšŒ ê°€ëŠ¥ì„±â€ ì¡°ì •ì— ì‚¬ìš©ë¼ìš”.
              </div>
              <div class="nav">
                <button class="btn" data-nav="back">ì´ì „</button>
                <button class="btn primary" id="btnShowResult">
                  ê²°ê³¼ ë³´ê¸°
                </button>
              </div>
            </div>

            <!-- RESULT: Candidates -->
            <div class="steps" data-step="candidates">
              <div class="hero" style="gap: 6px">
                <h3 style="font-size: 18px; margin: 0">
                  ì§€ê¸ˆ ìƒíƒœì— ë§ëŠ” ì„ íƒì´ì—ìš”
                </h3>
                <p class="muted">ì…‹ ì¤‘ í•˜ë‚˜ë§Œ ê³ ë¥´ë©´ ì¶©ë¶„í•´ìš”.</p>
              </div>

              <div class="sep"></div>

              <div class="candidates" id="candidateList"></div>

              <div class="sep"></div>

              <div class="nav">
                <button class="btn" data-nav="back">ì…ë ¥ ë‹¤ì‹œ</button>
                <button class="btn primary" id="btnGoFinal">
                  ì„ íƒí•œ ë©”ë‰´ë¡œ ê²°ì •
                </button>
              </div>
            </div>

            <!-- FINAL -->
            <div class="steps" data-step="final">
              <div class="finalBox">
                <div class="muted">ì˜¤ëŠ˜ì˜ ì„ íƒì€</div>
                <div class="big" id="finalMenu">â€”</div>
                <div class="sub" id="finalReason">â€”</div>
                <div class="nav">
                  <button class="btn" id="btnComplete">ê²°ì • ì™„ë£Œ</button>
                  <button class="btn ghost" id="btnBackToCandidates">
                    í›„ë³´ë¡œ ëŒì•„ê°€ê¸°
                  </button>
                </div>
              </div>

              <div class="sep"></div>

              <div class="hero">
                <h3 style="font-size: 16px; margin: 0">ê²°ì • ì´í›„ ì›ì¹™</h3>
                <p class="muted" style="margin: 0">
                  ê²°ì •ì‹íƒì€ â€œë‹¤ì‹œ ê³ ë¥´ê¸°â€ë³´ë‹¤ â€œê²°ì • ì¢…ë£Œâ€ë¥¼ ìš°ì„ í•´ìš”. ê·¸ë˜ì„œ
                  ë¦¬ìŠ¤íŠ¸ë¥¼ í¼ì¹˜ì§€ ì•Šê³ , ëŒ€ì²´ ë©”ë‰´ë„ 1ê°œì”©ë§Œ êµì²´í•´ìš”.
                </p>
              </div>
            </div>

            <!-- COMPLETE -->
            <div class="steps" data-step="complete">
              <div class="hero" style="gap: 8px">
                <h3 style="margin: 0">ê²°ì •ì€ ëë‚¬ì–´ìš” ğŸ‘</h3>
                <p class="muted" style="margin: 0">
                  ì´ì œ ê³ ë¯¼í•˜ì§€ ë§ê³  ë§›ìˆê²Œ ë¨¹ê¸°ë§Œ í•˜ì„¸ìš”.
                </p>

                <div class="sep"></div>

                <div class="nav">
                  <button class="btn" id="btnAgain">ë‹¤ì‹œ ê²°ì •í•˜ê¸°</button>
                  <button class="btn ghost" id="btnSaveHistory">
                    ì„ íƒ ê¸°ë¡ ì €ì¥(ë¡œì»¬)
                  </button>
                </div>
              </div>
            </div>

            <!-- MYDATA (Modal-ish in same card) -->
            <div class="steps" data-step="mydata">
              <div class="hero" style="gap: 8px">
                <h3 style="margin: 0">ë§ˆì´ë°ì´í„°(ì œì•½) ì„¤ì •</h3>
                <p class="muted" style="margin: 0">
                  ìì£¼ ì•ˆ ë°”ë€ŒëŠ” í•­ëª©ì€ ë¯¸ë¦¬ ì €ì¥í•˜ê³ , ì˜¤ëŠ˜ ìƒíƒœë§Œ 10ì´ˆ
                  ì…ë ¥í•´ìš”.
                </p>
              </div>

              <div class="sep"></div>

              <p class="q"><b>ì‹ìŠµê´€ / ì œì•½</b></p>
              <div class="options" id="optsDiet">
                <div class="opt" data-key="vegetarian" data-value="no">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ì±„ì‹ ì•„ë‹˜</strong>
                    <span>ê³ ê¸°/í•´ì‚°ë¬¼ ì¶”ì²œ í¬í•¨</span>
                  </div>
                </div>
                <div class="opt" data-key="vegetarian" data-value="yes">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ì±„ì‹(ê³ ê¸° ì œì™¸)</strong>
                    <span>ê³ ê¸° ê¸°ë°˜ ë©”ë‰´ ì œì™¸</span>
                  </div>
                </div>
              </div>

              <div class="sep"></div>

              <p class="q"><b>ë§¤ìš´ ìŒì‹</b></p>
              <div class="options" id="optsSpicy">
                <div class="opt" data-key="spicy" data-value="ok">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ê°€ëŠ¥</strong>
                    <span>ìê·¹ ë©”ë‰´ë„ í›„ë³´ì— í¬í•¨ë  ìˆ˜ ìˆì–´ìš”</span>
                  </div>
                </div>
                <div class="opt" data-key="spicy" data-value="avoid">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>í”¼í•˜ê³  ì‹¶ìŒ</strong>
                    <span>ì œìœ¡/ë–¡ë³¶ì´ ë“± ìê·¹ ë©”ë‰´ ìš°ì„  ì œì™¸</span>
                  </div>
                </div>
              </div>

              <div class="sep"></div>

              <p class="q"><b>íŠ¹ë³„í•œ ë‚ (ì˜ˆì™¸í˜• ì¹´ë“œ)</b></p>
              <div class="options" id="optsOccasion">
                <div class="opt" data-key="occasion" data-value="false">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>ì¼ìƒ</strong>
                    <span>ì˜ˆì™¸í˜•(ëìŠ¤í„°/ìŠ¤í…Œì´í¬) ê¸°ë³¸ ì œì™¸</span>
                  </div>
                </div>
                <div class="opt" data-key="occasion" data-value="true">
                  <div class="radio"><i></i></div>
                  <div class="lbl">
                    <strong>íŠ¹ë³„í•œ ë‚ </strong>
                    <span>ì¡°ê±´ ì¶©ì¡± ì‹œ ì˜ˆì™¸í˜• ì¹´ë“œ 1ê°œ ë…¸ì¶œ</span>
                  </div>
                </div>
              </div>

              <div class="helper">
                ë§ˆì´ë°ì´í„°ëŠ” â€œì¶”ì²œì„ ë°”ê¾¸ëŠ” ê¸°ëŠ¥â€ì´ ì•„ë‹ˆë¼ â€œë‚˜ì˜¤ë©´ ì•ˆ ë˜ëŠ” ê²ƒâ€
                ì œê±°(í•˜ë“œ í•„í„°) ì—­í• ì´ì—ìš”.
              </div>

              <div class="nav">
                <button class="btn" data-nav="back">ì´ì „</button>
                <button class="btn primary" id="btnSaveMyData">ì €ì¥</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Sidebar -->
        <aside class="sideCol">
          <section class="card">
            <div class="hd">
              <div class="title">
                <h2>í˜„ì¬ ìƒíƒœ(ì…ë ¥ ìš”ì•½)</h2>
                <p>ì…ë ¥ 3ê°œ + ë§ˆì´ë°ì´í„° ì œì•½</p>
              </div>
              <span class="tag"><span class="dot"></span>Explainable</span>
            </div>
            <div class="bd">
              <div class="kv" id="stateSummary"></div>
            </div>
          </section>

          <section class="card">
            <div class="hd">
              <div class="title">
                <h2>ìœ í˜• ì„ íƒ ê·œì¹™(ìš”ì•½)</h2>
                <p>ë©”ë‰´ê°€ ì•„ë‹ˆë¼ â€œì´ìœ (ìœ í˜•)â€ê°€ ë‹¨ìœ„</p>
              </div>
              <span class="tag"><span class="dot"></span>MVP</span>
            </div>
            <div class="bd">
              <div class="codebox" id="ruleBox"></div>
            </div>
          </section>

          <section class="card">
            <div class="hd">
              <div class="title">
                <h2>íˆìŠ¤í† ë¦¬(ë°˜ë³µ ë°©ì§€)</h2>
                <p>ìµœê·¼ 3íšŒ ì„ íƒ(ë¡œì»¬ ì €ì¥)</p>
              </div>
              <span class="tag"><span class="dot"></span>Rotation</span>
            </div>
            <div class="bd">
              <div class="codebox" id="historyBox"></div>
              <div class="nav" style="margin-top: 10px">
                <button class="btn" id="btnClearHistory">íˆìŠ¤í† ë¦¬ ì‚­ì œ</button>
              </div>
            </div>
          </section>
        </aside>
      </div>
    </div>

    <div class="toast" id="toast">ì €ì¥í–ˆì–´ìš”</div>

    <script>
      /*****************************************************************
       * Decision Table Prototype (Vanilla JS)
       * - Minimal inputs: Hunger, Stress, Time
       * - MyData: constraints (vegetarian, spicy, occasion)
       * - Output: 3 candidates with different Types
       * - Substitute: rotate within same Type, one-by-one (no list expansion)
       * - Final: pick 1 and close decision
       *****************************************************************/

      /*** Types ***/
      const TYPE = {
        STABILITY: "ì•ˆì •í˜•",
        SATISFY: "ë§Œì¡±í˜•",
        CERTAIN: "í™•ì‹¤í˜•",
        SPEED: "ì†ë„í˜•",
        OCCASION: "ì˜ˆì™¸í˜•",
      };

      /*** Default state ***/
      const state = {
        // Inputs
        hunger: null, // 1..3
        stress: null, // 1..3
        time: null, // "lunch" | "dinner"

        // MyData constraints
        mydata: {
          vegetarian: "no", // "no" | "yes"
          spicy: "avoid", // "ok" | "avoid"
          occasion: "false", // "false" | "true"
        },

        // Candidate result
        candidates: [], // {typeKey, typeLabel, menu, reason, poolKey}
        selectedTypeKey: null, // chosen candidate type
        final: null, // {menu, reason, typeKey}

        // History (menu picks)
        history: [], // array of {ts, menu, typeKey}
      };

      /*** Pools: menu candidates per Type (small but extensible) ***/
      const POOLS = {
        [TYPE.STABILITY]: [
          { name: "ì¹¼êµ­ìˆ˜", tags: ["mild", "daily"] },
          { name: "ì½©ë‚˜ë¬¼êµ­ + ë°¥", tags: ["mild", "daily"] },
          { name: "ì†Œê³ ê¸°ë¬´êµ­ + ë°¥", tags: ["mild", "daily"] },
          { name: "ìˆœë‘ë¶€ì°Œê°œ + ë°¥", tags: ["mild", "daily"] },
          { name: "ë¯¸ì—­êµ­ + ë°¥", tags: ["mild", "daily"] },
        ],
        [TYPE.SATISFY]: [
          { name: "ë¶ˆê³ ê¸°ë®ë°¥", tags: ["meat", "mild"] },
          { name: "ì†Œë¶ˆê³ ê¸° ë°±ë°˜", tags: ["meat", "mild"] },
          { name: "ê°„ì¥ ë‹­ê°ˆë¹„ ë®ë°¥", tags: ["meat", "mid"] },
          { name: "ì œìœ¡ë®ë°¥", tags: ["meat", "spicy"] },
          { name: "ì˜¤ì§•ì–´ë³¶ìŒ ë®ë°¥", tags: ["seafood", "spicy"] },
        ],
        [TYPE.CERTAIN]: [
          { name: "ëˆê¹ŒìŠ¤", tags: ["heavy", "daily"] },
          { name: "í–„ë²„ê±° ì„¸íŠ¸", tags: ["heavy", "fast"] },
          { name: "ì¹˜í‚¨(ì†ŒëŸ‰)", tags: ["heavy", "fast"] },
          { name: "ë–¡ë³¶ì´ + íŠ€ê¹€", tags: ["heavy", "spicy"] },
          { name: "í”¼ì(ì¡°ê°/ê°œì¸)", tags: ["heavy", "fast"] },
        ],
        [TYPE.SPEED]: [
          { name: "ê¹€ë°¥", tags: ["fast", "daily"] },
          { name: "ì»µë°¥", tags: ["fast"] },
          { name: "ë¼ë©´", tags: ["fast", "spicy"] },
          { name: "ìš°ë™", tags: ["fast", "mild"] },
        ],
        [TYPE.OCCASION]: [
          { name: "ëìŠ¤í„°(ì™¸ì‹)", tags: ["special", "seafood"] },
          { name: "ìŠ¤í…Œì´í¬", tags: ["special", "meat"] },
          { name: "ì˜¤ë§ˆì¹´ì„¸", tags: ["special", "seafood"] },
        ],
      };

      /*** Reasons per Type (fixed, explanation-friendly) ***/
      const REASON = {
        [TYPE.STABILITY]: "ì†ì„ í¸ì•ˆí•˜ê²Œ ì±„ì›Œì¤˜ì„œ ì§€ì¹œ ìƒíƒœì— ë¶€ë‹´ì´ ì—†ì–´ìš”.",
        [TYPE.SATISFY]: "ìê·¹ ì—†ì´ í¬ë§Œê°ì„ ì£¼ëŠ” ì‹¤íŒ¨ í™•ë¥  ë‚®ì€ ì„ íƒì´ì—ìš”.",
        [TYPE.CERTAIN]: "ê³ ë¯¼ ì—†ì´ í™•ì‹¤í•˜ê²Œ ë°°ë¶€ë¥¼ ìˆ˜ ìˆì–´ìš”.",
        [TYPE.SPEED]: "ë¹ ë¥´ê²Œ ë¨¹ê³  ëë‚¼ ìˆ˜ ìˆì–´ìš”.",
        [TYPE.OCCASION]: "ì˜¤ëŠ˜ì€ íš¨ìœ¨ë³´ë‹¤ ê²½í—˜ì„ ì„ íƒí•´ë„ í›„íšŒê°€ ì ì–´ìš”.",
      };

      /*** UI helpers ***/
      const $ = (sel, el = document) => el.querySelector(sel);
      const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));

      const toastEl = $("#toast");
      function toast(msg) {
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        setTimeout(() => toastEl.classList.remove("show"), 1300);
      }

      /*** Persist history & mydata (localStorage) ***/
      const LS_KEY = "decision_table_v1";
      function loadLocal() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (parsed?.history) state.history = parsed.history;
          if (parsed?.mydata)
            state.mydata = { ...state.mydata, ...parsed.mydata };
        } catch (_) {}
      }
      function saveLocal() {
        localStorage.setItem(
          LS_KEY,
          JSON.stringify({ history: state.history, mydata: state.mydata })
        );
      }

      /*** Step navigation ***/
      const stepOrder = [
        "hero",
        "hunger",
        "stress",
        "time",
        "candidates",
        "final",
        "complete",
        "mydata", // treated as modal-like step, can be opened from anywhere
      ];

      let currentStep = "hero";
      let stepStack = []; // for back navigation, excluding mydata open/close

      function setStep(next, opts = { push: true }) {
        // Hide all
        $$(".steps").forEach((s) => s.classList.remove("active"));
        const target = $(`.steps[data-step="${next}"]`);
        if (!target) return;

        // Push stack
        if (opts.push && next !== "mydata") stepStack.push(currentStep);

        currentStep = next;
        target.classList.add("active");
        syncHeader();
        renderSidebar();
      }

      function backStep() {
        // If on mydata, return to previous displayed step (no stack effect)
        if (currentStep === "mydata") {
          const prev = stepStack.length
            ? stepStack[stepStack.length - 1]
            : "hero";
          setStep(prev, { push: false });
          return;
        }

        const prev = stepStack.pop() || "hero";
        setStep(prev, { push: false });
      }

      function syncHeader() {
        const titleEl = $("#stepTitle");
        const descEl = $("#stepDesc");
        const bar = $("#progressBar");

        const map = {
          hero: {
            t: "01 / ì‹œì‘",
            d: "ì˜¤ëŠ˜ ìƒíƒœë§Œ ì…ë ¥í•˜ë©´, ì´ìœ ê°€ ë‹¤ë¥¸ 3ê°œë§Œ ë³´ì—¬ì¤˜ìš”.",
            p: 10,
          },
          hunger: { t: "02 / ë°°ê³ í””", d: "í¬ë§Œê°ì˜ ê°•ë„ë¥¼ ì •í•´ìš”.", p: 30 },
          stress: { t: "03 / ì»¨ë””ì…˜", d: "ìê·¹/ì•ˆì •ì˜ ë°©í–¥ì„ ì •í•´ìš”.", p: 55 },
          time: {
            t: "04 / ì‹œê°„ëŒ€",
            d: "í›„íšŒ ê°€ëŠ¥ì„±ê³¼ ë¶€ë‹´ì„ ì¡°ì •í•´ìš”.",
            p: 75,
          },
          candidates: {
            t: "05 / í›„ë³´ 3ê°œ",
            d: "ì„œë¡œ ë‹¤ë¥¸ ì´ìœ  3ê°œë§Œ ì œì‹œí•´ìš”.",
            p: 90,
          },
          final: { t: "06 / ìµœì¢… ê²°ì •", d: "ê²°ì •ì€ ì—¬ê¸°ì„œ ë.", p: 100 },
          complete: { t: "07 / ì™„ë£Œ", d: "ì´ì œ ê³ ë¯¼í•˜ì§€ ë§ê³  ë¨¹ê¸°ë§Œ.", p: 100 },
          mydata: {
            t: "ì„¤ì • / ë§ˆì´ë°ì´í„°",
            d: "ìì£¼ ì•ˆ ë°”ë€ŒëŠ” ì œì•½ì„ ì €ì¥í•´ìš”.",
            p: 20,
          },
        };

        const m = map[currentStep] || map.hero;
        titleEl.textContent = m.t;
        descEl.textContent = m.d;
        bar.style.width = m.p + "%";
      }

      /*** Input selection UI ***/
      function wireOptions(containerSel, onPick) {
        const box = $(containerSel);
        if (!box) return;

        box.addEventListener("click", (e) => {
          const opt = e.target.closest(".opt");
          if (!opt) return;
          $$(".opt", box).forEach((o) => o.classList.remove("selected"));
          opt.classList.add("selected");
          onPick(opt);
          renderSidebar();
        });
      }

      wireOptions("#optsHunger", (opt) => {
        state.hunger = Number(opt.dataset.value);
      });

      wireOptions("#optsStress", (opt) => {
        state.stress = Number(opt.dataset.value);
      });

      wireOptions("#optsTime", (opt) => {
        state.time = opt.dataset.value;
      });

      // MyData
      function wireMyDataOptions(containerSel) {
        const box = $(containerSel);
        if (!box) return;
        box.addEventListener("click", (e) => {
          const opt = e.target.closest(".opt");
          if (!opt) return;
          const key = opt.dataset.key;
          const value = opt.dataset.value;

          // group select by key
          const siblings = $$(".opt", box).filter((o) => o.dataset.key === key);
          siblings.forEach((o) => o.classList.remove("selected"));
          opt.classList.add("selected");

          state.mydata[key] = value;
          renderSidebar();
        });
      }
      wireMyDataOptions("#optsDiet");
      wireMyDataOptions("#optsSpicy");
      wireMyDataOptions("#optsOccasion");

      /*** Buttons: generic next/back inside steps (input screens) ***/
      document.addEventListener("click", (e) => {
        const navBtn = e.target.closest("[data-nav]");
        if (!navBtn) return;
        const dir = navBtn.dataset.nav;

        if (dir === "back") {
          backStep();
          return;
        }
        if (dir === "next") {
          if (currentStep === "hunger" && !state.hunger)
            return toast("ë°°ê³ í””ì„ ì„ íƒí•´ì¤˜");
          if (currentStep === "stress" && !state.stress)
            return toast("ì»¨ë””ì…˜ì„ ì„ íƒí•´ì¤˜");
          if (currentStep === "time" && !state.time)
            return toast("ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•´ì¤˜");

          if (currentStep === "hunger") return setStep("stress");
          if (currentStep === "stress") return setStep("time");
          return;
        }
      });

      /*** Header buttons ***/
      $("#btnStart").addEventListener("click", () => {
        setStep("hunger");
      });
      $("#btnHeroGoInput").addEventListener("click", () => {
        setStep("hunger");
      });
      $("#btnHeroMyData").addEventListener("click", () => {
        // open mydata from hero (keep stack)
        setStep("mydata", { push: true });
      });

      $("#btnOpenMyData").addEventListener("click", () => {
        setStep("mydata", { push: true });
      });

      $("#btnReset").addEventListener("click", () => resetAll());

      /*** MyData save ***/
      $("#btnSaveMyData").addEventListener("click", () => {
        saveLocal();
        toast("ë§ˆì´ë°ì´í„° ì €ì¥");
        // return to previous step
        backStep();
      });

      /*** Result generation ***/
      $("#btnShowResult").addEventListener("click", () => {
        if (!state.hunger || !state.stress || !state.time) {
          toast("ì…ë ¥ì„ ë¨¼ì € ì™„ë£Œí•´ì¤˜");
          return;
        }
        generateCandidates();
        setStep("candidates");
      });

      /*** Candidate selection & actions ***/
      function renderCandidates() {
        const list = $("#candidateList");
        list.innerHTML = "";

        state.candidates.forEach((c) => {
          const card = document.createElement("div");
          card.className = "menuCard";
          card.dataset.typeKey = c.typeKey;

          const badgeClass = badgeClassFor(c.typeLabel);

          card.innerHTML = `
            <div class="menuTop">
              <div class="menuTitle">
                <div class="type">
                  <span class="badge ${badgeClass}">${c.typeLabel}</span>
                  <span class="muted">ì´ìœ  1ì¤„</span>
                </div>
                <h4>${escapeHtml(c.menu)}</h4>
              </div>
              <div class="menuActions">
                <button class="btn" data-action="substitute">ë‹¤ë¥¸ ì„ íƒ ë³´ê¸°</button>
                <button class="btn primary" data-action="pick">ì´ ë©”ë‰´ë¡œ</button>
              </div>
            </div>
            <p class="reason">${escapeHtml(c.reason)}</p>
          `;

          list.appendChild(card);
        });

        // Attach handlers
        list.onclick = (e) => {
          const btn = e.target.closest("button");
          const card = e.target.closest(".menuCard");
          if (!btn || !card) return;
          const typeKey = card.dataset.typeKey;
          const action = btn.dataset.action;

          if (action === "substitute") {
            substituteWithinType(typeKey);
            renderCandidates();
            toast("ëŒ€ì²´ ë©”ë‰´ë¡œ êµì²´");
            return;
          }
          if (action === "pick") {
            const chosen = state.candidates.find((x) => x.typeKey === typeKey);
            if (!chosen) return;
            state.selectedTypeKey = typeKey;
            state.final = {
              menu: chosen.menu,
              reason: chosen.reason,
              typeKey: chosen.typeKey,
              typeLabel: chosen.typeLabel,
            };
            // go final step
            $("#finalMenu").textContent = chosen.menu;
            $("#finalReason").textContent = chosen.reason;
            setStep("final");
            return;
          }
        };
      }

      $("#btnGoFinal").addEventListener("click", () => {
        if (!state.final) {
          toast("í›„ë³´ì—ì„œ â€˜ì´ ë©”ë‰´ë¡œâ€™ë¥¼ ëˆŒëŸ¬ ì„ íƒí•´ì¤˜");
          return;
        }
        setStep("final");
      });

      $("#btnBackToCandidates").addEventListener("click", () => {
        setStep("candidates", { push: false });
      });

      $("#btnComplete").addEventListener("click", () => {
        if (!state.final) return;

        // Save to in-memory history
        state.history.unshift({
          ts: Date.now(),
          menu: state.final.menu,
          typeKey: state.final.typeKey,
          typeLabel: state.final.typeLabel,
        });
        state.history = state.history.slice(0, 3);
        saveLocal();
        renderSidebar();

        setStep("complete");
      });

      $("#btnAgain").addEventListener("click", () => {
        // start new decision but keep mydata + history
        state.hunger = null;
        state.stress = null;
        state.time = null;
        state.candidates = [];
        state.selectedTypeKey = null;
        state.final = null;

        clearSelections();
        setStep("hunger");
      });

      $("#btnSaveHistory").addEventListener("click", () => {
        saveLocal();
        toast("ê¸°ë¡ ì €ì¥");
      });

      $("#btnClearHistory").addEventListener("click", () => {
        state.history = [];
        saveLocal();
        renderSidebar();
        toast("íˆìŠ¤í† ë¦¬ ì‚­ì œ");
      });

      /*** Reset all (including mydata) ***/
      function resetAll() {
        state.hunger = null;
        state.stress = null;
        state.time = null;
        state.candidates = [];
        state.selectedTypeKey = null;
        state.final = null;
        state.mydata = { vegetarian: "no", spicy: "avoid", occasion: "false" };
        state.history = [];
        localStorage.removeItem(LS_KEY);

        clearSelections();
        syncMyDataSelections();
        renderSidebar();
        setStep("hero", { push: false });
        stepStack = [];
        toast("ì´ˆê¸°í™” ì™„ë£Œ");
      }

      function clearSelections() {
        ["#optsHunger", "#optsStress", "#optsTime"].forEach((sel) => {
          const box = $(sel);
          if (!box) return;
          $$(".opt", box).forEach((o) => o.classList.remove("selected"));
        });
      }

      /*** Candidate algorithm (more concrete, explainable) ***/
      function generateCandidates() {
        // 1) choose 3 different types based on inputs + mydata
        const H = state.hunger;
        const S = state.stress;
        const T = state.time;

        // Active type candidates (priority based)
        let types = [];

        // Base preference: Always try to include Stability + Satisfy + Certain
        // But apply constraints and input gating
        // - Stability: H>=2 and S>=2
        if (H >= 2 && S >= 2) types.push(TYPE.STABILITY);

        // - Satisfy: H>=2 and S>=2 and spicy not strongly avoided OR allow mild satisfy only
        types.push(TYPE.SATISFY); // allow satisfy generally; menu filter handles spicy constraint

        // - Certain: H==3 (very hungry), but reduce if dinner + stress high (burden)
        if (H === 3) types.push(TYPE.CERTAIN);

        // - Speed: optional (not asking time shortage input in MVP), so only when lunch + stress low
        if (T === "lunch" && S <= 2) types.push(TYPE.SPEED);

        // - Occasion: only when mydata occasion true + stress low + dinner
        if (state.mydata.occasion === "true" && S === 1 && T === "dinner") {
          types.unshift(TYPE.OCCASION); // insert early, but only 1 slot
        }

        // 2) Deduplicate while preserving order
        types = [...new Set(types)];

        // 3) Force pick 3 distinct types with fallback logic
        const pickedTypes = [];
        for (const t of types) {
          if (pickedTypes.length >= 3) break;
          if (!pickedTypes.includes(t)) pickedTypes.push(t);
        }
        // fallback fill
        const fallbackOrder = [
          TYPE.STABILITY,
          TYPE.SATISFY,
          TYPE.CERTAIN,
          TYPE.SPEED,
          TYPE.OCCASION,
        ];
        for (const t of fallbackOrder) {
          if (pickedTypes.length >= 3) break;
          if (!pickedTypes.includes(t)) pickedTypes.push(t);
        }

        // 4) For each picked type, choose a menu from pool with constraints + history avoidance
        state.candidates = pickedTypes.map((typeLabel) => {
          const menu = pickMenuFromPool(typeLabel);
          return {
            typeKey: typeKeyFromLabel(typeLabel),
            typeLabel,
            menu: menu.name,
            reason: reasonFor(typeLabel, menu),
            poolKey: typeLabel,
            // store index to allow substitute rotation
            cursor: menu.cursor,
          };
        });

        // 5) Reset selected final
        state.final = null;
        state.selectedTypeKey = null;

        renderCandidates();
        renderSidebar();
      }

      function reasonFor(typeLabel, menuObj) {
        // Slightly personalize reasons to feel "decision-based"
        if (typeLabel === TYPE.SATISFY) {
          // If spicy avoided, emphasize mild
          if (state.mydata.spicy === "avoid") {
            return "ìê·¹ì€ ì¤„ì´ë©´ì„œë„ í¬ë§Œê°ì„ ì£¼ëŠ” ë§Œì¡±í˜• ì„ íƒì´ì—ìš”.";
          }
          return REASON[typeLabel];
        }
        if (typeLabel === TYPE.CERTAIN) {
          if (state.time === "dinner" && state.stress === 3) {
            return "í™•ì‹¤í•˜ê²Œ ë°°ë¶€ë¥´ë˜, ê³¼ë¶€ë‹´ì´ ëŠê»´ì§€ë©´ ë‹¤ë¥¸ ì¹´ë“œë¡œ ë°”ê¿”ë„ ë¼ìš”.";
          }
          return REASON[typeLabel];
        }
        return REASON[typeLabel];
      }

      function pickMenuFromPool(typeLabel) {
        // Apply hard constraints: vegetarian removes meat-heavy menus from satisfy/certain/occasion pools
        const constraints = state.mydata;

        let pool = (POOLS[typeLabel] || []).slice();

        // Vegetarian filter
        if (constraints.vegetarian === "yes") {
          pool = pool.filter((m) => !m.tags.includes("meat"));
        }

        // Spicy avoid filter (avoid spicy-tag menus)
        if (constraints.spicy === "avoid") {
          pool = pool.filter((m) => !m.tags.includes("spicy"));
        }

        // If pool becomes empty, fallback to mild daily foods (stability)
        if (!pool.length) {
          pool = (POOLS[TYPE.STABILITY] || []).slice();
        }

        // History avoidance: prefer menu not used recently
        const used = new Set(state.history.map((h) => h.menu));
        const fresh = pool.filter((m) => !used.has(m.name));
        const chosenPool = fresh.length ? fresh : pool;

        // Rotate by simple cursor stored per type in localStorage? We'll compute cursor from time
        const cursor = Date.now() % chosenPool.length;
        const picked = chosenPool[cursor];
        return { ...picked, cursor };
      }

      function substituteWithinType(typeKey) {
        const idx = state.candidates.findIndex((c) => c.typeKey === typeKey);
        if (idx < 0) return;
        const c = state.candidates[idx];
        const typeLabel = c.typeLabel;

        // rebuild pool with constraints
        let pool = (POOLS[typeLabel] || []).slice();
        if (state.mydata.vegetarian === "yes") {
          pool = pool.filter((m) => !m.tags.includes("meat"));
        }
        if (state.mydata.spicy === "avoid") {
          pool = pool.filter((m) => !m.tags.includes("spicy"));
        }
        if (!pool.length) pool = (POOLS[TYPE.STABILITY] || []).slice();

        // rotate to next
        const curIndex = pool.findIndex((m) => m.name === c.menu);
        const nextIndex = curIndex >= 0 ? (curIndex + 1) % pool.length : 0;
        const nextMenu = pool[nextIndex];

        state.candidates[idx] = {
          ...c,
          menu: nextMenu.name,
          // reason text must remain consistent per rule (same type)
          reason: reasonFor(typeLabel, nextMenu),
        };

        // If final already selected from this type, update final to keep consistency
        if (state.final && state.final.typeKey === typeKey) {
          state.final.menu = nextMenu.name;
          state.final.reason = state.candidates[idx].reason;
          $("#finalMenu").textContent = state.final.menu;
          $("#finalReason").textContent = state.final.reason;
        }
      }

      function typeKeyFromLabel(label) {
        // stable internal keys
        const map = {
          [TYPE.STABILITY]: "STABILITY",
          [TYPE.SATISFY]: "SATISFY",
          [TYPE.CERTAIN]: "CERTAIN",
          [TYPE.SPEED]: "SPEED",
          [TYPE.OCCASION]: "OCCASION",
        };
        return map[label] || label;
      }

      function badgeClassFor(typeLabel) {
        if (typeLabel === TYPE.STABILITY) return "stability";
        if (typeLabel === TYPE.SATISFY) return "satisfy";
        if (typeLabel === TYPE.CERTAIN) return "certain";
        if (typeLabel === TYPE.SPEED) return "speed";
        if (typeLabel === TYPE.OCCASION) return "occasion";
        return "";
      }

      /*** Sidebar render ***/
      function renderSidebar() {
        // Summary
        const sum = $("#stateSummary");
        sum.innerHTML = "";

        const hungerText =
          state.hunger === 1
            ? "ì¡°ê¸ˆ"
            : state.hunger === 2
            ? "ë³´í†µ"
            : state.hunger === 3
            ? "ë§ì´"
            : "â€”";
        const stressText =
          state.stress === 1
            ? "ì—¬ìœ "
            : state.stress === 2
            ? "ë³´í†µ"
            : state.stress === 3
            ? "ì§€ì¹¨"
            : "â€”";
        const timeText =
          state.time === "lunch"
            ? "ì ì‹¬"
            : state.time === "dinner"
            ? "ì €ë…"
            : "â€”";

        const rows = [
          ["ë°°ê³ í””", hungerText],
          ["ì»¨ë””ì…˜", stressText],
          ["ì‹œê°„ëŒ€", timeText],
          [
            "ì±„ì‹",
            state.mydata.vegetarian === "yes" ? "ê³ ê¸° ì œì™¸" : "ì œì•½ ì—†ìŒ",
          ],
          ["ë§¤ìš´ë§›", state.mydata.spicy === "avoid" ? "í”¼í•¨" : "ê°€ëŠ¥"],
          ["íŠ¹ë³„í•œ ë‚ ", state.mydata.occasion === "true" ? "ON" : "OFF"],
        ];

        rows.forEach(([k, v]) => {
          const div = document.createElement("div");
          div.className = "kvRow";
          div.innerHTML = `<b>${escapeHtml(k)}</b><span>${escapeHtml(
            v
          )}</span>`;
          sum.appendChild(div);
        });

        // RuleBox (short)
        $("#ruleBox").textContent = [
          "ìœ í˜• ì„ íƒ ê¸°ì¤€ (MVP)",
          "",

          "- ì•ˆì •í˜•:",
          "  ë°°ê³ í””ì´ ë³´í†µ ìˆ˜ì¤€ì´ê³  ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ìˆëŠ” ê²½ìš°.",
          "  ì‹¤íŒ¨ ê°€ëŠ¥ì„±ì´ ë‚®ì€ ë¬´ë‚œí•œ ì„ íƒì„ ìš°ì„ í•©ë‹ˆë‹¤.",
          "",
          "- ë§Œì¡±í˜•:",
          "  ë°°ê³ í””ê³¼ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ëª¨ë‘ ë†’ì€ ê²½ìš°.",
          "  ìœ„ë¡œì™€ ë§Œì¡±ê°ì„ ì£¼ëŠ” ì„ íƒì„ ì œì‹œí•©ë‹ˆë‹¤.",
          "",
          "- í™•ì‹¤í˜•:",
          "  ë°°ê³ í””ì´ ë§¤ìš° ë†’ì€ ê²½ìš°.",
          "  ë¹ ë¥¸ í¬ë§Œê°ê³¼ ì‹ì‚¬ ì™„ë£Œ ì†ë„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²°ì •í•©ë‹ˆë‹¤.",
          "",
          "- íŠ¹ë³„í•œ ë‚ :",
          "  íŠ¹ë³„í•œ ë‚ ë¡œ ì„¤ì •ë˜ì–´ ìˆê³  ì €ë… ì‹ì‚¬ì´ë©° ì‹œê°„ì  ì—¬ìœ ê°€ ìˆì„ ë•Œ.",
          "  ì„ íƒì„ ë„“íˆì§€ ì•Šê³  í•˜ë‚˜ì˜ ë©”ë‰´ë§Œ ì œì•ˆí•©ë‹ˆë‹¤.",
          "",
          "ëŒ€ì²´ ë©”ë‰´ ì œê³µ ë°©ì‹",
          "- ì „ì²´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ í¼ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
          "- ë™ì¼í•œ ìœ í˜• ë‚´ì—ì„œë§Œ í•œ ê°œì”© êµì²´í•©ë‹ˆë‹¤.",
          "",
          "ê²°ì • ì¢…ë£Œ",
          "- í›„ë³´ 3ê°œ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ë©´ ê²°ì •ì€ ì¢…ë£Œë©ë‹ˆë‹¤.",
        ].join("\n");

        // History
        const hb = $("#historyBox");
        if (!state.history.length) {
          hb.textContent = "ê¸°ë¡ ì—†ìŒ";
        } else {
          hb.textContent = state.history
            .map((h, i) => {
              const dt = new Date(h.ts);
              const mm = String(dt.getMonth() + 1).padStart(2, "0");
              const dd = String(dt.getDate()).padStart(2, "0");
              const hh = String(dt.getHours()).padStart(2, "0");
              const mi = String(dt.getMinutes()).padStart(2, "0");
              return `${i + 1}. [${mm}-${dd} ${hh}:${mi}] ${h.menu} (${
                h.typeLabel
              })`;
            })
            .join("\n");
        }

        // If on candidates, ensure list is rendered
        if (currentStep === "candidates") renderCandidates();
      }

      /*** MyData selections sync ***/
      function syncMyDataSelections() {
        // for each mydata group, set selected class
        const applyGroup = (containerSel, key) => {
          const box = $(containerSel);
          if (!box) return;
          $$(".opt", box).forEach((o) => o.classList.remove("selected"));
          const target = $(
            `.opt[data-key="${key}"][data-value="${state.mydata[key]}"]`,
            box
          );
          if (target) target.classList.add("selected");
        };
        applyGroup("#optsDiet", "vegetarian");
        applyGroup("#optsSpicy", "spicy");
        applyGroup("#optsOccasion", "occasion");
      }

      /*** Small helpers ***/
      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      /*** Init ***/
      loadLocal();
      syncMyDataSelections();
      renderSidebar();
      syncHeader();

      // Wire topbar start
      $("#btnStart").click();

      // Actually don't auto-start; keep hero visible
      // Undo the click above; show hero
      setStep("hero", { push: false });
      stepStack = [];

      // Ensure mydata selections reflect loaded state
      syncMyDataSelections();

      // Also support "start" from topbar without leaving hero stack weirdness
      $("#btnStart").addEventListener("click", () => {
        setStep("hunger");
      });
    </script>
  </body>
</html>
